<!doctype html>
<html lang = "en" ng-app= "details_app">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Angular Material style sheet -->
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.8/angular-material.min.css">

<link rel="stylesheet" href="material-start/styles/main.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/angular-material/1.1.0-rc2/angular-material.min.css">
<link rel = "stylesheet"
   href = "https://ajax.googleapis.com/ajax/libs/angular_material/1.0.0/angular-material.min.css">
<script src = "https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
<script src = "https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-animate.min.js"></script>
<script src = "https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-aria.min.js"></script>
<script src = "https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-messages.min.js"></script>
<script src = "https://ajax.googleapis.com/ajax/libs/angular_material/1.0.0/angular-material.min.js"></script>
<script src="https://apis.google.com/js/client:platform.js?onload=start" async defer>
</script>

<!--- google login --------->

<link href="/node_modules/angular-material-time-picker/dist/md-time-picker.css" rel="stylesheet" type="text/css"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="form.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>

<script src="/node_modules/angular/angular.js"></script>
<!-- <script src="/node_modules/angular-material-time-picker/index.js"></script> -->

<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>

</head>

<style>
.centered {
display: flex;
align-items: center;
justify-content: center;
}
</style>

<body  layout="column" ng-cloak class="md-inline-form">
<md-sidenav class="md-sidenav-left" md-component-id="left" md-whiteframe="4">
          <div ng-controller="profile_ctrl" ng-cloak>
          <md-toolbar class="md-theme-indigo" style="min-height:20vh">
            <div style="height:20px;"></div>
            <div layout="row" layout-align="center center" style="margin-bottom: 5px;">
            <img  style="border-radius: 50%;border-style: solid;border-color: #ffffff;"  src="https://lh3.googleusercontent.com/-XdUIqdMkCWA/AAAAAAAAAAI/AAAAAAAAAAA/4252rscbv5M/photo.jpg?sz=100"/>
           </div>
           <div layout="row" layout-align="center center">
             <span ng-bind="ride.author"></span>
           </div>
             <div layout="row" layout-align="center center">
               <div layout="row" layout-align="center center">
               <div layout="row" >
                 <md-icon i class="material-icons">star_rate</md-icon>
                  <small><span ng-bind="user_info.rating"></span></small>
               </div>
               <div style="width:50px;"></div>
               <div layout="row">
                 <md-icon i class="material-icons">directions_car</md-icon>
                 <small><span ng-bind="user_info.ride_count"></span></small>
               </div>
             </div>

             </div>
          </md-toolbar>
        </div>
          <md-content layout-margin="">
              <md-input-container class="md-block" style="margin-top:10px;" flex-gt-sm>
                <label>Description</label>
               <textarea ng-model="" md-maxlength="1000" rows="10" md-select-on-focus></textarea>
              </md-input-container>
          </md-content>

        </md-sidenav>
      </div>

<md-toolbar  class="md-hue-2" ng-controller="toolbar_ctrl">
  <div class="md-toolbar-tools">
    <md-button  class="md-icon-button" ng-click="toggleLeft()">
      <md-icon i class="material-icons">menu</md-icon>
    </md-button>

    <h2 flex="" md-truncate="">SURide</h2>
    <span flex></span>
      <md-button ng-show="myride"
   ng-click="editApplicants()">
        <md-icon>edit</md-icon>
          Applicants
      </md-button>
      <md-button ng-href="/home">
        <md-icon>directions_car</md-icon>
          Check Rides
      </md-button>
        <!-- Search button (initiates search) -->
        <md-button id="search-button" ng-click="initiateSearch()" ng-hide="showSearchBar()">
          <md-icon>search</md-icon>
          <span>Search</span>
        </md-button>

        <div ng-show="showSearchBar()" class="md-toolbar-tools search-bar">

        <md-button class="md-icon-button" ng-click="submit()">
          <md-icon>search</md-icon>
        </md-button>

        <!-- Input Text -->
        <md-input-container flex>
          <!-- <label for="search">Search</label> -->
          <input id="search-input" type="text" ng-model="search" ng-change="submit()"/>
        </md-input-container>

        <md-button class="md-icon-button" ng-click="endSearch()">
          <md-icon>close</md-icon>
        </md-button>
      </div>

  </div>
</md-toolbar>
  <md-content >
    <md-card layout-fill >
      <div ng-controller="card_detail_ctrl" ng-cloak>

        <md-card-header>
        <div style="display: flex;align-items: center;justify-content: center;">
          <!-- <md-button class="md-icon-button" aria-label="Profile"> -->
<!--           <md-icon i class="material-icons" style="font-size: 2em">account_circle</md-icon>
 -->        </md-button>
        </div>

        <md-card-header-text>
          <div layout-sm="row">
          <div class="centered">
            <div layout="row" >
                  <div class="md-headline" ng-bind="ride.name"></div>

            </div>
          </div>
          <div flex>
          <span class="md-card-content" style="font-size: 1em"><span ></span></span>
          </div>
          </div>
        </md-card-header-text>
      </md-card-header>

       <md-card-content class="md-card-content">
         

          <div layout="row" layout-align="center center">
               <div layout="row" layout-align="center center">
               <div layout="row" >
                 <md-icon i class="material-icons" style="font-size: 2em">location_on</md-icon>
             <div style="font-size: 1.5em;">&nbsp;&nbsp;<span ng-bind="ride.dest"></span></div>
               </div>
               <div style="width:50px;"></div>
               <div layout="row" >
                 <md-icon i class="material-icons" style="font-size: 2em">event_seat</md-icon>
             <div style="font-size: 1.5em;">&nbsp;&nbsp;<span ng-bind="ride.seats"></span></div>
               </div>
               <div style="width:50px;"></div>
               <div layout="row" >
                 <md-icon i class="material-icons" style="font-size: 2em">access_time</md-icon>
             <div style="font-size: 1.5em;">&nbsp;&nbsp;<span ng-bind="ride.deptime"></span></div>
               </div>
             </div>
          </div>
         <p style="min-height:36px;word-wrap: break-word;"><b>Description:</b> <br/><span style="margin-left: 6em;" ng-bind="ride.desc"></span></p>
         <div style="min-height:500px;" id="map" flex></div>
         <div class="md-media-lg card-media">
           <img ng-src="{{i.mapurl}}"/>
         </div>
      </md-card-content>

      <md-card-actions layout="row" layout-align="end center" class="layout-align-end-center layout-row">
        <md-button class="md-fab md-primary" aria-label="Apply" ng-click="apply()">
              <md-icon i class="material-icons ">check_circle</md-icon>
        </md-button>
      </md-card-actions>
    </div>
    </md-card>
</md-content>



    <script>
    angular.module('details_app', ['ngMaterial'])
    .controller('toolbar_ctrl', function($scope,$rootScope, $mdSidenav){
      var url = new URL(window.location);
      var id = url.searchParams.get("id");

      
      $scope.editApplicants = function(){
        window.open('/editapplicants?id='+id,'targetWindow','toolbar=no, location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=SomeSize,height=SomeSize');
      };


      $scope.myride = false;
      $scope.$on('userinfo', function(events, args){
          console.log(args);
          $scope.user_info = args; //now we've registered!
          if($scope.user_info.id == id.substring(0,id.length-5)){$scope.myride = true;$scope.apply();}
        });

      $scope.toggleLeft = function(){
              $mdSidenav('left').toggle();
            };


           $scope.search = null;
           $scope.showPreSearchBar = function() {
             return $scope.search == null;
           };
           $scope.initiateSearch = function() {
             $scope.search = '';
           };
           $scope.showSearchBar = function() {
             return $scope.search != null
           };
           $scope.endSearch = function() {
             return $scope.search = null;
           };
           $scope.submit = function() {
             $rootScope.$broadcast('search', $scope.search)
             console.error('Search function not yet implemented');
           }

           // to focus on input element after it appears
           $scope.$watch(function() {
             return document.querySelector('#search-bar:not(.ng-hide)');
           }, function(){
               document.getElementById('search-input').focus();
           });
    })
    .controller('profile_ctrl', function($scope, $rootScope){
      $scope.logout = function() {
        $.ajax({
          type: "POST",
          url: "http://localhost:3000/logout",
          headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },contentType: 'application/json',
    xhrFields: {withCredentials: true},

          success: function(data){
            if(data=="logout") {window.location.replace("http://localhost:3000/");}
            else{alert("Error logging out!");}
          }
        });

      };

        $.get("http://localhost:3000/userinfo",function(data){
          console.log(data);
          $scope.user_info = {user_name:data.name,rating:data.rating,ride_count:data.rides, id:data._id};
          $rootScope.$broadcast('userinfo',$scope.user_info);
        });

      $scope.get_user_name = function(){
        return $scope.user_info.user_name;
      };
      $scope.get_rating = function(){
        return $scope.user_info.rating;
      };
      $scope.get_ride_count = function(){
        return $scope.user_info.ride_count;
      };

    })
    .controller('card_detail_ctrl', function($scope, $http, $mdDialog){
      var url = new URL(window.location);
      var id = url.searchParams.get("id");
      $scope.ride = {};

      $scope.apply = function(ev){
        $http({method: 'GET',url: '/applyride?id='+id}).then(function successCallback(response){
              $mdDialog.show(
              $mdDialog.alert()
                .parent(angular.element(document.querySelector('md-card')))
                .clickOutsideToClose(true)
                .title('Alert')
                .textContent(response.data)
                .ariaLabel('Alert Dialog')
                .ok('Got it!')
                .targetEvent(ev)
            );
          
        }, function errorCallback(response){
          $mdDialog.show(
              $mdDialog.alert()
                .parent(angular.element(document.querySelector('md-card')))
                .clickOutsideToClose(true)
                .title('Alert')
                .textContent(response.data)
                .ariaLabel('Alert Dialog')
                .ok('Got it!')
                .targetEvent(ev)
            );
        });
      };

      $http({
        method: 'GET',
        url: '/getride?id='+id
      }).then(function successCallback(response) {
          // this callback will be called asynchronously
          // when the response is available
          console.log(response.data.dest);
          $scope.ride = response.data;
          var location = {lat: $scope.ride.loc.lat, lng: $scope.ride.loc.long};

      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 14,
        center: location,
        mapTypeId: 'terrain'
      });
      var marker = new google.maps.Marker({position: location, map: map});
          console.log($scope.ride);
        }, function errorCallback(response) {
          // called asynchronously if an error occurs
          // or server returns response with an error status.
        });

      $scope.get_destination = function(){
        return $scope.ride.destination;
      };
      $scope.get_author = function(){
        return $scope.ride.author;
      };
    });

    function initMap() {
      var Kadikoy = {lat: 40.9811277, lng: 29.0280337};

      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 14,
        center: Kadikoy,
        mapTypeId: 'terrain'
      });

    }
    </script>
    <!--Load the API from the specified URL
    * The async attribute allows the browser to render the page while the API loads
    * The key parameter will contain your own API key (which is not needed for this tutorial)
    * The callback parameter executes the initMap() function
    -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDtZptno5dSTfvD-php6kPSBRCXhzDgHa8&callback=initMap"></script>


</body>

</html>
